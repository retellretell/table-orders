<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>í…Œì´ë¸” ì£¼ë¬¸</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;600;700;900&display=swap');
  :root {
    --bg: #1a1a1a; --surface: #242424; --card: #2e2e2e;
    --accent: #ff6b35; --accent2: #ffd166; --text: #f0ede8;
    --muted: #888; --border: #3a3a3a; --green: #06d6a0; --red: #ef476f;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Noto Sans KR', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; overflow-x: hidden; }

  header { background: var(--surface); padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
  header h1 { font-size: 18px; font-weight: 900; color: var(--accent); }
  header span { font-size: 12px; color: var(--muted); }

  .layout-section { padding: 20px; }
  .floor-map { background: var(--surface); border-radius: 16px; padding: 14px; border: 1px solid var(--border); margin-bottom: 20px; }
  .floor-title { font-size: 13px; font-weight: 700; color: var(--muted); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
  .floor-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

  .table-btn { background: var(--card); border: 2px solid var(--border); border-radius: 12px; padding: 10px 4px; min-width: 0; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 6px; position: relative; -webkit-tap-highlight-color: transparent; user-select: none; }
  .table-btn:active { transform: scale(0.95); }
  .table-btn.has-order { border-color: var(--accent); background: rgba(255,107,53,0.08); }
  .table-btn.has-order .table-icon { background: var(--accent); color: white; }
  .table-icon { width: 40px; height: 40px; border-radius: 8px; background: var(--border); display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 900; color: var(--text); transition: all 0.2s; }
  .table-name { font-size: 10px; font-weight: 600; color: var(--muted); }
  .order-badge { position: absolute; top: 6px; right: 6px; background: var(--accent); color: white; border-radius: 10px; font-size: 9px; font-weight: 700; padding: 2px 6px; min-width: 18px; text-align: center; display: none; }
  .table-btn.has-order .order-badge { display: block; }

  /* Modal */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 200; display: none; align-items: flex-end; backdrop-filter: blur(4px); }
  .modal-overlay.open { display: flex; }
  .modal { background: var(--surface); border-radius: 24px 24px 0 0; width: 100%; max-height: 85vh; display: flex; flex-direction: column; animation: slideUp 0.3s ease; border-top: 1px solid var(--border); }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  .modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 12px auto 0; }
  .modal-header { padding: 16px 20px 12px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); }
  .modal-title { font-size: 20px; font-weight: 900; color: var(--accent); }
  .modal-subtitle { font-size: 12px; color: var(--muted); margin-top: 2px; }
  .modal-close { background: var(--card); border: none; color: var(--text); width: 32px; height: 32px; border-radius: 50%; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
  .modal-body { flex: 1; overflow-y: auto; padding: 16px 20px; }

  .orders-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 16px; }
  .order-item { background: var(--card); border-radius: 12px; padding: 12px 14px; display: flex; align-items: center; gap: 12px; border: 1px solid var(--border); animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
  .order-item-time { font-size: 10px; color: var(--muted); white-space: nowrap; }
  .order-item-text { flex: 1; font-size: 14px; font-weight: 500; line-height: 1.4; word-break: break-all; }
  .order-item-del { background: none; border: none; color: var(--muted); font-size: 18px; cursor: pointer; padding: 4px; border-radius: 6px; transition: all 0.15s; flex-shrink: 0; }
  .order-item-del:active { color: var(--red); background: rgba(239,71,111,0.1); }
  .empty-state { text-align: center; padding: 32px 0; color: var(--muted); font-size: 13px; }
  .empty-state .icon { font-size: 36px; margin-bottom: 8px; display: block; }

  .input-area { border-top: 1px solid var(--border); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); background: var(--surface); display: flex; gap: 10px; align-items: flex-end; position: relative; }
  .input-wrap { flex: 1; background: var(--card); border-radius: 12px; border: 1.5px solid var(--border); display: flex; align-items: center; padding: 0 12px; transition: border-color 0.2s; }
  .input-wrap:focus-within { border-color: var(--accent); }
  .order-input { background: none; border: none; color: var(--text); font-size: 14px; font-family: inherit; width: 100%; padding: 12px 0; outline: none; resize: none; max-height: 80px; line-height: 1.4; }
  .order-input::placeholder { color: var(--muted); }

  .autocomplete-box { position: absolute; bottom: 100%; left: 20px; right: 20px; background: #1e1e1e; border: 1.5px solid var(--accent); border-radius: 14px 14px 0 0; max-height: 230px; overflow-y: auto; z-index: 999; display: none; }
  .autocomplete-box.show { display: block; }
  .ac-item { padding: 11px 14px; cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid var(--border); -webkit-tap-highlight-color: transparent; }
  .ac-item:last-child { border-bottom: none; }
  .ac-item:active { background: rgba(255,107,53,0.15); }
  .ac-left { flex: 1; min-width: 0; }
  .ac-name { font-size: 13px; font-weight: 700; line-height: 1.3; }
  .ac-name em { color: var(--accent); font-style: normal; }
  .ac-en { font-size: 11px; color: var(--muted); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .ac-price { font-size: 13px; color: var(--accent2); font-weight: 700; flex-shrink: 0; margin-left: 10px; padding-top: 1px; }

  .add-btn { background: var(--accent); border: none; color: white; width: 44px; height: 44px; border-radius: 12px; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s; flex-shrink: 0; }
  .add-btn:active { transform: scale(0.9); background: #e55a27; }

  .modal-actions { display: flex; gap: 8px; margin-bottom: 12px; }
  .btn-clear { flex: 1; background: rgba(239,71,111,0.1); border: 1px solid rgba(239,71,111,0.3); color: var(--red); padding: 10px; border-radius: 10px; font-size: 13px; font-weight: 600; font-family: inherit; cursor: pointer; transition: all 0.15s; }
  .btn-clear:active { background: rgba(239,71,111,0.2); }

  .total-bar { background: var(--card); border-radius: 12px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); margin-bottom: 12px; }
  .total-label { font-size: 12px; color: var(--muted); font-weight: 600; }
  .total-count { font-size: 18px; font-weight: 900; color: var(--accent2); }

  /* ì „ì²´ ì£¼ë¬¸ í */
  .queue-section { padding: 0 20px 40px; }
  .queue-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .queue-title { font-size: 15px; font-weight: 900; color: var(--text); display: flex; align-items: center; gap: 8px; }
  .queue-count-badge { background: var(--accent); color: white; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 20px; }
  .queue-clear-btn { background: none; border: 1px solid var(--border); color: var(--muted); font-size: 11px; font-family: inherit; padding: 5px 10px; border-radius: 8px; cursor: pointer; }
  .queue-empty { text-align: center; padding: 28px 0; color: var(--muted); font-size: 13px; background: var(--surface); border-radius: 14px; border: 1px dashed var(--border); }
  .queue-list { display: flex; flex-direction: column; gap: 8px; }
  .queue-columns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: start; }
  .queue-col-title { font-size: 11px; font-weight: 900; color: var(--muted); letter-spacing: 0.5px; text-transform: uppercase; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
  .queue-col { display: flex; flex-direction: column; gap: 8px; }
  .queue-item { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 10px 10px; display: flex; align-items: center; gap: 8px; animation: fadeIn 0.2s ease; }
  .queue-table-tag { background: var(--accent); color: white; font-size: 11px; font-weight: 900; width: 28px; height: 28px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
  .queue-item-text { font-size: 13px; font-weight: 600; line-height: 1.3; }
  .queue-item-time { font-size: 10px; color: var(--muted); margin-top: 2px; }
  .queue-done-btn { background: var(--green); border: none; color: #000; font-size: 16px; width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; font-weight: 900; transition: all 0.15s; -webkit-tap-highlight-color: transparent; }
  .queue-done-btn:active { transform: scale(0.88); opacity: 0.8; }
  .queue-item.served { opacity: 0; transform: translateX(60px); transition: all 0.35s ease; }

  .side-checks { display: flex; gap: 6px; margin-top: 7px; flex-wrap: wrap; }
  .side-chip { background: var(--card); border: 1.5px solid var(--border); color: var(--muted); font-size: 12px; font-weight: 700; font-family: inherit; padding: 4px 10px; border-radius: 20px; cursor: pointer; transition: all 0.15s; -webkit-tap-highlight-color: transparent; }
  .side-chip.checked { background: rgba(6,214,160,0.15); border-color: var(--green); color: var(--green); text-decoration: line-through; opacity: 0.7; }
  .side-chip:active { transform: scale(0.93); }

  .sync-indicator { font-size: 10px; color: var(--muted); display: flex; align-items: center; gap: 4px; }
  .sync-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }
  .sync-dot.off { background: var(--red); }

  .queue-search-wrap { margin-bottom: 12px; }
  .queue-search-input { width: 100%; background: var(--surface); border: 1.5px solid var(--border); border-radius: 12px; color: var(--text); font-size: 14px; font-family: inherit; padding: 10px 14px; outline: none; transition: border-color 0.2s; }
  .queue-search-input:focus { border-color: var(--accent); }
  .queue-search-input::placeholder { color: var(--muted); }
  .queue-item.highlight { border-color: var(--accent2); background: rgba(255,209,102,0.07); }
  .queue-item-text em { color: var(--accent2); font-style: normal; font-weight: 900; }

  /* ë¹„ë°€ë²ˆí˜¸ í™”ë©´ */
  .pin-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 32px; }
  .pin-overlay.hidden { display: none; }
  .pin-logo { font-size: 40px; }
  .pin-title { font-size: 20px; font-weight: 900; color: var(--text); }
  .pin-subtitle { font-size: 13px; color: var(--muted); margin-top: -24px; }
  .pin-dots { display: flex; gap: 16px; }
  .pin-dot { width: 14px; height: 14px; border-radius: 50%; background: var(--border); transition: background 0.15s; }
  .pin-dot.filled { background: var(--accent); }
  .pin-keypad { display: grid; grid-template-columns: repeat(3, 72px); grid-template-rows: repeat(4, 72px); gap: 12px; }
  .pin-key { background: var(--surface); border: 1.5px solid var(--border); border-radius: 50%; font-size: 22px; font-weight: 700; font-family: inherit; color: var(--text); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.12s; -webkit-tap-highlight-color: transparent; user-select: none; }
  .pin-key:active { background: var(--card); transform: scale(0.92); }
  .pin-key.confirm { background: var(--accent); border-color: var(--accent); color: white; font-size: 14px; font-weight: 900; }
  .pin-key.confirm:active { background: #e55a27; }
  .pin-key.del { font-size: 18px; }
  .pin-error { color: var(--red); font-size: 13px; font-weight: 700; min-height: 18px; transition: opacity 0.2s; }
  @keyframes shake {
    0%,100% { transform: translateX(0); }
    20%      { transform: translateX(-8px); }
    40%      { transform: translateX(8px); }
    60%      { transform: translateX(-6px); }
    80%      { transform: translateX(6px); }
  }

  /* ìˆ˜ëŸ‰ ì»¨íŠ¸ë¡¤ (ì£¼ë¬¸ í•­ëª© ë‚´) */
  .qty-ctrl { display: flex; align-items: center; gap: 4px; flex-shrink: 0; }
  .qty-ctrl-btn { background: var(--card); border: 1.5px solid var(--border); color: var(--text); width: 26px; height: 26px; border-radius: 8px; font-size: 16px; font-weight: 700; font-family: inherit; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.12s; -webkit-tap-highlight-color: transparent; line-height: 1; }
  .qty-ctrl-btn:active { transform: scale(0.88); background: var(--border); }
  .qty-ctrl-num { font-size: 15px; font-weight: 900; color: var(--accent); min-width: 20px; text-align: center; }

  /* ì†ŒìŠ¤ ë”°ë¡œ / ìŠ¤íŒŒì´ì‹œ í† ê¸€ */
  .sauce-toggle-btn { background: none; border: 1px solid var(--border); color: var(--muted); font-size: 11px; font-weight: 700; font-family: inherit; padding: 3px 8px; border-radius: 6px; cursor: pointer; transition: all 0.15s; white-space: nowrap; flex-shrink: 0; }
  .sauce-toggle-btn.active { background: rgba(255,107,53,0.15); border-color: var(--accent); color: var(--accent); }
  .sauce-toggle-btn:active { transform: scale(0.95); }
  .spicy-toggle-btn { background: none; border: 1px solid var(--border); color: var(--muted); font-size: 11px; font-weight: 700; font-family: inherit; padding: 3px 8px; border-radius: 6px; cursor: pointer; transition: all 0.15s; white-space: nowrap; flex-shrink: 0; }
  .spicy-toggle-btn.active { background: rgba(239,71,111,0.15); border-color: var(--red); color: var(--red); }
  .spicy-toggle-btn:active { transform: scale(0.95); }
  .spicy-tag { display: inline-block; background: rgba(239,71,111,0.15); border: 1px solid var(--red); color: var(--red); font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: 6px; margin-left: 4px; vertical-align: middle; }
  .sauce-aside-tag { display: inline-block; background: rgba(255,107,53,0.15); border: 1px solid var(--accent); color: var(--accent); font-size: 10px; font-weight: 700; padding: 1px 6px; border-radius: 6px; margin-left: 4px; vertical-align: middle; }

  /* ë²„ì „ í‘¸í„° */
  .app-footer { text-align: center; padding: 16px 20px 32px; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .app-version { font-size: 11px; font-weight: 700; color: var(--accent); }
  .app-divider { font-size: 11px; color: var(--border); }
  .app-credit  { font-size: 11px; color: var(--muted); }
</style>
</head>
<body>

<div class="pin-overlay" id="pinOverlay">
  <div class="pin-logo">ğŸ½</div>
  <div class="pin-title">Rice Junky</div>
  <div class="pin-subtitle">ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
  <div class="pin-dots" id="pinDots">
    <div class="pin-dot" id="pd0"></div>
  </div>
  <div class="pin-error" id="pinError"></div>
  <div class="pin-keypad">
    <div class="pin-key" onclick="pinInput('1')">1</div>
    <div class="pin-key" onclick="pinInput('2')">2</div>
    <div class="pin-key" onclick="pinInput('3')">3</div>
    <div class="pin-key" onclick="pinInput('4')">4</div>
    <div class="pin-key" onclick="pinInput('5')">5</div>
    <div class="pin-key" onclick="pinInput('6')">6</div>
    <div class="pin-key" onclick="pinInput('7')">7</div>
    <div class="pin-key" onclick="pinInput('8')">8</div>
    <div class="pin-key" onclick="pinInput('9')">9</div>
    <div class="pin-key del" onclick="pinDelete()">âŒ«</div>
    <div class="pin-key" onclick="pinInput('0')">0</div>
    <div class="pin-key confirm" onclick="pinConfirm()">í™•ì¸</div>
  </div>
</div>

<header>
  <h1>ğŸ½ í…Œì´ë¸” ì£¼ë¬¸</h1>
  <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;">
    <span id="activeCount">ì£¼ë¬¸ 0í…Œì´ë¸”</span>
    <div class="sync-indicator"><div class="sync-dot off" id="syncDot"></div><span id="syncText">ì—°ê²°ì¤‘...</span></div>
  </div>
</header>

<div class="layout-section">
  <div class="floor-map">
    <div class="floor-title">í™€ ë°°ì¹˜ë„</div>
    <div style="display:grid;grid-template-columns:repeat(7,minmax(0,1fr));grid-template-rows:repeat(4,auto);gap:6px;">
      <!-- 1ì—´ -->
      <div class="table-btn" onclick="openTable('1')" id="tbl-1"><div class="order-badge" id="badge-1"></div><div class="table-icon">1</div><div class="table-name">T1</div></div>
      <!-- ê°€ìš´ë° 1í–‰ -->
      <div></div>
      <div class="table-btn" onclick="openTable('4')" id="tbl-4"><div class="order-badge" id="badge-4"></div><div class="table-icon">4</div><div class="table-name">T4</div></div>
      <div class="table-btn" onclick="openTable('5')" id="tbl-5"><div class="order-badge" id="badge-5"></div><div class="table-icon">5</div><div class="table-name">T5</div></div>
      <div class="table-btn" onclick="openTable('6')" id="tbl-6"><div class="order-badge" id="badge-6"></div><div class="table-icon">6</div><div class="table-name">T6</div></div>
      <div></div>
      <!-- 7ì—´ -->
      <div class="table-btn" onclick="openTable('10')" id="tbl-10"><div class="order-badge" id="badge-10"></div><div class="table-icon">10</div><div class="table-name">T10</div></div>

      <!-- 1ì—´ -->
      <div class="table-btn" onclick="openTable('2')" id="tbl-2"><div class="order-badge" id="badge-2"></div><div class="table-icon">2</div><div class="table-name">T2</div></div>
      <!-- ê°€ìš´ë° 2í–‰ -->
      <div></div>
      <div class="table-btn" onclick="openTable('7')" id="tbl-7"><div class="order-badge" id="badge-7"></div><div class="table-icon">7</div><div class="table-name">T7</div></div>
      <div class="table-btn" onclick="openTable('8')" id="tbl-8"><div class="order-badge" id="badge-8"></div><div class="table-icon">8</div><div class="table-name">T8</div></div>
      <div class="table-btn" onclick="openTable('9')" id="tbl-9"><div class="order-badge" id="badge-9"></div><div class="table-icon">9</div><div class="table-name">T9</div></div>
      <div></div>
      <!-- 7ì—´ -->
      <div class="table-btn" onclick="openTable('11')" id="tbl-11"><div class="order-badge" id="badge-11"></div><div class="table-icon">11</div><div class="table-name">T11</div></div>

      <!-- 1ì—´ -->
      <div class="table-btn" onclick="openTable('3-1')" id="tbl-3-1"><div class="order-badge" id="badge-3-1"></div><div class="table-icon" style="font-size:13px;">3-1</div><div class="table-name">T3-1</div></div>
      <div></div><div></div><div></div><div></div><div></div>
      <!-- 7ì—´ -->
      <div class="table-btn" onclick="openTable('12-1')" id="tbl-12-1"><div class="order-badge" id="badge-12-1"></div><div class="table-icon" style="font-size:13px;">12-1</div><div class="table-name">T12-1</div></div>

      <!-- 1ì—´ -->
      <div class="table-btn" onclick="openTable('3-2')" id="tbl-3-2"><div class="order-badge" id="badge-3-2"></div><div class="table-icon" style="font-size:13px;">3-2</div><div class="table-name">T3-2</div></div>
      <div></div><div></div><div></div><div></div><div></div>
      <!-- 7ì—´ -->
      <div class="table-btn" onclick="openTable('12-2')" id="tbl-12-2"><div class="order-badge" id="badge-12-2"></div><div class="table-icon" style="font-size:13px;">12-2</div><div class="table-name">T12-2</div></div>
    </div>
  </div>
</div>

<div class="queue-section">
  <div class="queue-header">
    <div class="queue-title">ğŸ§¾ ë‚˜ê°€ì•¼ í•  ë©”ë‰´ <span class="queue-count-badge" id="queueCountBadge">0</span></div>
    <button class="queue-clear-btn" onclick="clearServedAll()">ì „ì²´ ì™„ë£Œ</button>
  </div>
  <div class="queue-search-wrap">
    <input type="text" id="queueSearch" class="queue-search-input" placeholder="ğŸ” ë©”ë‰´ ê²€ìƒ‰... (ì˜ˆ: ê·œì¹´ì¸ , ì•ˆì‹¬)" oninput="renderQueue()">
  </div>
  <div id="queueList" class="queue-list"><div class="queue-empty">ì•„ì§ ì£¼ë¬¸ì´ ì—†ì–´ìš”</div></div>
</div>
<footer class="app-footer">
  <span class="app-version">v1.4.0 &nbsp;Â·&nbsp; 2026.02.26</span>
  <span class="app-divider">|</span>
  <span class="app-credit">made by C.R.</span>
</footer>

<div class="modal-overlay" id="modalOverlay" onclick="handleOverlayClick(event)">
  <div class="modal" id="modal">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <div>
        <div class="modal-title" id="modalTitle">í…Œì´ë¸”</div>
        <div class="modal-subtitle" id="modalSubtitle">ì£¼ë¬¸ ë‚´ì—­</div>
      </div>
      <button class="modal-close" onclick="closeModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="total-bar">
        <span class="total-label">ğŸ“‹ ì£¼ë¬¸ í•­ëª©</span>
        <span class="total-count" id="orderCount">0ê°œ</span>
      </div>
      <div class="modal-actions">
        <button class="btn-clear" onclick="clearAllOrders()">ğŸ—‘ ì „ì²´ ì‚­ì œ</button>
      </div>
      <div class="orders-list" id="ordersList"></div>
    </div>
    <div class="input-area">
      <div class="autocomplete-box" id="acBox"></div>
      <div class="input-wrap">
        <textarea class="order-input" id="orderInput" placeholder="ë©”ë‰´ ê²€ìƒ‰ ë˜ëŠ” ì§ì ‘ ì…ë ¥..." rows="1"
          onkeydown="handleKey(event)"
          onblur="hideAC()"
          oninput="autoResize(this); showAC(this.value)"></textarea>
      </div>
      <button class="add-btn" onclick="addOrder()">+</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCt4xzx3BoVo_-NORVwCW9e_GzeR49BgfY",
    authDomain: "rice-junky-order.firebaseapp.com",
    databaseURL: "https://rice-junky-order-default-rtdb.firebaseio.com",
    projectId: "rice-junky-order",
    storageBucket: "rice-junky-order.firebasestorage.app",
    messagingSenderId: "440569792772",
    appId: "1:440569792772:web:3788b89bc35f0cbe9e6851"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const ordersRef = ref(db, 'orders');

  let orders = {};
  let currentTable = null;

  // ===== ë©”ë‰´ ë°ì´í„° =====
  const MENU = [
    { ko: 'ì„œìš¸ ê²½ì–‘ì‹ ëˆê¹ŒìŠ¤', en: 'Seoul Classic Pork Cutlet', price: '$18.99', sides: ['ğŸ´ í¬í¬ë‚˜ì´í”„'],
      keywords: ['ì„œìš¸','ê²½ì–‘ì‹','ëˆê¹ŒìŠ¤','ëˆì¹´ì¸ ','í´ë˜ì‹','classic','seoul','pork','cutlet','ê¹ŒìŠ¤','ì¹´ì¸ ','katsu','donkatsu'] },
    { ko: 'í‚¹íƒ€ì´ê±° í”„ë¼ìš´ ê¹ŒìŠ¤', en: 'King Tiger Prawn Katsu', price: '$43', sides: ['ğŸš ë°¥', 'ğŸ´ í¬í¬ë‚˜ì´í”„'],
      keywords: ['í‚¹íƒ€ì´ê±°','í‚¹','í”„ë¼ìš´','ìƒˆìš°','ê¹ŒìŠ¤','ì¹´ì¸ ','katsu','king','tiger','prawn','shrimp'] },
    { ko: 'ë“±ì‹¬ ê¹ŒìŠ¤', en: 'Pork Loin Katsu', price: '$24', sides: ['ğŸš ë°¥'],
      keywords: ['ë“±ì‹¬','ë¡œì¸','loin','ê¹ŒìŠ¤','ì¹´ì¸ ','katsu','pork'] },
    { ko: 'ì•ˆì‹¬ ê¹ŒìŠ¤', en: 'Pork Tenderloin Katsu', price: '$25', sides: ['ğŸš ë°¥'],
      keywords: ['ì•ˆì‹¬','í…ë”ë¡œì¸','í…ë”','tenderloin','tender','ê¹ŒìŠ¤','ì¹´ì¸ ','katsu','pork'] },
    { ko: 'ê·œ ê¹ŒìŠ¤', en: 'Gyukatsu (Beef Cutlet)', price: '$38', sides: ['ğŸš ë°¥','ğŸ”¥ ê·¸ë¦´'],
      keywords: ['ê·œ','ê·œì¹´ì¸ ','ê·œê¹ŒìŠ¤','ì†Œê³ ê¸°','beef','gyukatsu','gyu','ê¹ŒìŠ¤','ì¹´ì¸ ','katsu','cutlet'] },
    { ko: 'ë¬¸ì–´ ê¹ŒìŠ¤', en: 'Octopus Katsu', price: '$39', sides: ['ğŸš ë°¥', 'ğŸ´ í¬í¬ë‚˜ì´í”„'],
      keywords: ['ë¬¸ì–´','ì˜¥í† í¼ìŠ¤','octopus','ê¹ŒìŠ¤','ì¹´ì¸ ','katsu'] },
    { ko: 'ì¹˜ì¦ˆ ê¹ŒìŠ¤', en: 'Cheese Katsu', price: '$26', sides: ['ğŸš ë°¥'],
      keywords: ['ì¹˜ì¦ˆ','cheese','ê¹ŒìŠ¤','ì¹´ì¸ ','katsu'] },
    { ko: 'ìˆ¯ë¶ˆê°ˆë¹„ ìŠ¤í…Œì´í¬', en: 'Charcoal-Grilled Galbi Steak', price: '$35', sides: ['ğŸš ë°¥'],
      keywords: ['ìˆ¯ë¶ˆ','ê°ˆë¹„','ìŠ¤í…Œì´í¬','charcoal','grilled','galbi','steak','ribs'] },
    { ko: 'KFC ì¹˜í‚¨', en: 'Korean Fried Chicken Thigh', price: '$17', sides: ['ğŸš ë°¥'],
      keywords: ['kfc','ì¹˜í‚¨','ë‹­ë‹¤ë¦¬','korean','fried','chicken','thigh','í”„ë¼ì´ë“œ'] },
    { ko: 'ì¡°ë­ì´ë–¡ë³¶ì´', en: 'Mini Rice Cake Tteokbokki', price: '$16', sides: [],
      keywords: ['ì¡°ë­ì´','ë–¡ë³¶ì´','ë–¡','tteokbokki','ricecake','spicy'] },
    { ko: 'ì‚¼ê²¹ì‚´ íŠ€ê¹€', en: 'Crispy Pork Belly', price: '$18', sides: [],
      keywords: ['ì‚¼ê²¹ì‚´','ì‚¼ê²¹','íŠ€ê¹€','porkbelly','belly','crispy'] },
    { ko: 'ì—°ì–´ì¥', en: 'Soy-Marinated Salmon', price: '$19', sides: [],
      keywords: ['ì—°ì–´','ì—°ì–´ì¥','salmon','soy','marinated'] },
    { ko: 'ì°¨ëŒë°•ì´ ë¹„ë¹”íŒŒìŠ¤íƒ€', en: 'Spicy Beef Brisket Pasta', price: '$17', sides: [],
      keywords: ['ì°¨ëŒ','ì°¨ëŒë°•ì´','ë¹„ë¹”','íŒŒìŠ¤íƒ€','pasta','beef','brisket','spicy'] },
    { ko: 'ê½ˆë¦¬ê³ ì¶” ë²„ì„¯êµ¬ì´', en: 'Blistered Shishito Peppers & Mushrooms', price: '$15', sides: [],
      keywords: ['ê½ˆë¦¬','ê½ˆë¦¬ê³ ì¶”','ë²„ì„¯','êµ¬ì´','shishito','pepper','mushroom','blistered'] },
    { ko: 'ì¡°ê°œíƒ•', en: 'Clam Soup (SPICY +$1)', price: '$16', sides: ['ğŸ¥„ êµ­ì', 'ğŸœ ì•ì ‘ì‹œ'],
      keywords: ['ì¡°ê°œ','ì¡°ê°œíƒ•','clam','í´ë¨','soup','spicy'] },
    { ko: 'ë‹­ê°•ì •', en: 'Korean Sweet & Spicy Chicken Bites', price: '$14', sides: [],
      keywords: ['ë‹­ê°•ì •','ê°•ì •','ë‹­','chicken','sweet','spicy','bites'] },
    { ko: 'ë² ì´ì»¨ ê¹€ì¹˜ ìƒˆìš° ì–‘ë°°ì¶” ì „', en: 'Bacon, Kimchi, Shrimp & Cabbage Jeon', price: '$18', sides: ['ğŸ´ í¬í¬ë‚˜ì´í”„'],
      keywords: ['ë² ì´ì»¨','ê¹€ì¹˜','ìƒˆìš°','ì–‘ë°°ì¶”','ì „','jeon','bacon','kimchi','shrimp','cabbage','pancake'] },
    { ko: 'ì½œë¼', en: 'Coke', price: '$2', sides: [],
      keywords: ['ì½œë¼','coke','cola'] },
    { ko: 'ë‹¤ì´ì–´íŠ¸ì½œë¼', en: 'Diet Coke', price: '$2', sides: [],
      keywords: ['ì½œë¼','ë‹¤ì´ì–´íŠ¸ì½œë¼','ë‹¤ì´ì–´íŠ¸','dietcoke','diet','cola'] },
    { ko: 'ìŠ¤í”„ë¼ì´íŠ¸', en: 'Sprite', price: '$2', sides: [],
      keywords: ['ìŠ¤í”„ë¼ì´íŠ¸','sprite','ì‚¬ì´ë‹¤'] },
    { ko: 'ë°€í‚¤ìŠ¤', en: 'Milkis', price: '$2', sides: [],
      keywords: ['ë°€í‚¤ìŠ¤','milkis'] },
    { ko: 'ì†Œì£¼', en: 'Soju (Chamisul, Jinro, Saero)', price: '$11', sides: [],
      keywords: ['ì†Œì£¼','ì°¸ì´ìŠ¬','ì§„ë¡œ','ìƒˆë¡œ','soju','chamisul','jinro','saero'] },
    { ko: 'í•œêµ­ ë§¥ì£¼', en: 'Korean Beer (CASS, TERRA)', price: '$10', sides: [],
      keywords: ['í•œêµ­ë§¥ì£¼','ë§¥ì£¼','ì¹´ìŠ¤','í…Œë¼','cass','terra','beer','korean'] },
    { ko: 'IPA ë§¥ì£¼', en: 'Local IPA Beer', price: '$8', sides: [],
      keywords: ['ipa','ì•„ì´í”¼ì—ì´','local','beer','craft','ë¡œì»¬','ë§¥ì£¼'] },
    { ko: 'ë¸”ë¡ ë“œ ë§¥ì£¼', en: 'Local Blonde Beer', price: '$8', sides: [],
      keywords: ['ë¸”ë¡ ë“œ','ë¸”ë¡ ','blonde','local','beer','craft','ë¡œì»¬','ë§¥ì£¼'] },
    { ko: 'ì²˜ë¡œ ë§¥ì£¼', en: 'Local Churro Beer', price: '$8', sides: [],
      keywords: ['ì²˜ë¡œ','ì¶”ë¡œ','ì¸„ë¡œ','churro','local','beer','craft','ë¡œì»¬','ë§¥ì£¼'] },
    { ko: 'í—¤ì´ì§€ ë§¥ì£¼', en: 'Local Hazy Beer', price: '$8', sides: [],
      keywords: ['í—¤ì´ì§€','í—¤ì´ì¦ˆ','í•˜ì§€','hazy','local','beer','craft','ë¡œì»¬','ë§¥ì£¼'] },
    { ko: 'ë§‰ê±¸ë¦¬', en: 'Makgeolli (Korean Rice Wine)', price: '$11', sides: [],
      keywords: ['ë§‰ê±¸ë¦¬','makgeolli','ricewine','íƒì£¼'] },
    { ko: 'ìƒë§¥ì£¼', en: 'Draft Beer (Lagunitas, Modelo)', price: '$8', sides: [],
      keywords: ['ìƒë§¥ì£¼','ìƒ','draft','ë¼êµ¬ë‹ˆíƒ€ìŠ¤','ëª¨ë¸ë¡œ','lagunitas','modelo'] },
  ];

  // ===== ìƒìˆ˜ =====
  const SAUCE_ASIDE_TAG   = 'ğŸ¥£ì†ŒìŠ¤ë”°ë¡œ';
  const CLASSIC_CUTLET_KO = 'ì„œìš¸ ê²½ì–‘ì‹ ëˆê¹ŒìŠ¤';
  const SPICY_TAG         = 'ğŸŒ¶ï¸ìŠ¤íŒŒì´ì‹œ';
  const CLAM_SOUP_KO      = 'ì¡°ê°œíƒ•';
  const SERVE_ANIM_MS     = 320; // ì„œë¹™ ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„

  // ë©”ë‰´íŒ KATSU ì„¹ì…˜ ê¸°ì¤€ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ (ì´ ë©”ë‰´ë“¤ë§Œ ì¹´ì¸  ì»¬ëŸ¼ì— í‘œì‹œ)
  const KATSU_MENU_KO = new Set([
    'ì„œìš¸ ê²½ì–‘ì‹ ëˆê¹ŒìŠ¤', 'í‚¹íƒ€ì´ê±° í”„ë¼ìš´ ê¹ŒìŠ¤', 'ë“±ì‹¬ ê¹ŒìŠ¤',
    'ì•ˆì‹¬ ê¹ŒìŠ¤', 'ê·œ ê¹ŒìŠ¤', 'ë¬¸ì–´ ê¹ŒìŠ¤', 'ì¹˜ì¦ˆ ê¹ŒìŠ¤',
    'ìˆ¯ë¶ˆê°ˆë¹„ ìŠ¤í…Œì´í¬', 'KFC ì¹˜í‚¨',
  ]);

  // ===== ìœ í‹¸ =====
  function normalize(str) { return str.toLowerCase().replace(/\s/g,''); }

  /** ë©”ë‰´íŒ KATSU ì„¹ì…˜ ë©”ë‰´ì¸ì§€ í™•ì¸ */
  function isKatsuItem(text) {
    return MENU.some(m => KATSU_MENU_KO.has(m.ko) && normalize(text).includes(normalize(m.ko)));
  }

  /** í…Œì´ë¸”ì˜ ì£¼ë¬¸ ë°°ì—´ì—ì„œ itemIdë¡œ í•­ëª© ë°˜í™˜ */
  function findItemById(table, itemId) {
    return (orders[table] || []).find(it => (it.id || it.time) === itemId) || null;
  }

  /** í…Œì´ë¸”ì˜ ì£¼ë¬¸ ë°°ì—´ì—ì„œ itemIdë¡œ ì¸ë±ìŠ¤ ë°˜í™˜ */
  function findItemIndexById(table, itemId) {
    return (orders[table] || []).findIndex(it => (it.id || it.time) === itemId);
  }

  /** ë¹ˆ í…Œì´ë¸” í‚¤ ì •ë¦¬ */
  function cleanTableOrders(table) {
    if (orders[table] && orders[table].length === 0) delete orders[table];
  }

  function getSidesForText(text) {
    const t = normalize(text);
    // ì§§ì€ í‚¤ì›Œë“œ(2ì ì´í•˜)ëŠ” ì™„ì „ì¼ì¹˜ ë˜ëŠ” ì•ì—ì„œ ì‹œì‘í•  ë•Œë§Œ ë§¤ì¹­
    // endsWith ì œê±°: 'ê·œì¹´ì¸ '.endsWith('ì¹´ì¸ ')=true ê°™ì€ ì˜¤ë§¤ì¹­ ë°©ì§€
    for (const m of MENU) {
      if (m.keywords && m.keywords.some(k => {
        const nk = normalize(k);
        if (nk.length <= 2) return t === nk; // startsWith ì œê±°: 'ìƒˆìš°' ê²€ìƒ‰ì´ ë‹¤ë¥¸ ë©”ë‰´ ë§¤ì¹­í•˜ëŠ” ì˜¤ë¥˜ ë°©ì§€
        return t.includes(nk);
      })) return m.sides;
    }
    return [];
  }

  function highlight(str, query) {
    const q = query.toLowerCase();
    const idx = str.toLowerCase().indexOf(q);
    if (idx === -1) return escapeHtml(str);
    return escapeHtml(str.slice(0,idx)) + '<em>' + escapeHtml(str.slice(idx,idx+q.length)) + '</em>' + escapeHtml(str.slice(idx+q.length));
  }

  function escapeHtml(str) {
    return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  }

  const ALL_TAGS = [SAUCE_ASIDE_TAG, SPICY_TAG];

  /** í…ìŠ¤íŠ¸ì—ì„œ íƒœê·¸ì™€ ìˆ˜ëŸ‰ì„ ë¶„ë¦¬í•´ì„œ ë°˜í™˜
   *  â†’ { base, qty, tags, displayText }
   *  base: ë©”ë‰´ëª…+ê°€ê²©ë§Œ (íƒœê·¸/ìˆ˜ëŸ‰ ì—†ìŒ)
   *  qty: ìˆ˜ëŸ‰ (ì—†ìœ¼ë©´ 1)
   *  tags: ë¶™ì–´ìˆë˜ íƒœê·¸ ë°°ì—´ (ìˆœì„œ ìœ ì§€)
   *  displayText: base (UI í‘œì‹œìš©, escapeHtml ë¯¸ì ìš©)
   */
  function parseItemText(text) {
    let t = text;
    const tags = ALL_TAGS.filter(tag => t.includes(tag));
    tags.forEach(tag => { t = t.replace(' ' + tag, ''); });
    t = t.trimEnd();
    const qtyMatch = t.match(/ x(\d+)$/);
    const qty  = qtyMatch ? parseInt(qtyMatch[1]) : 1;
    const base = t.replace(/ x\d+$/, '');
    return { base, qty, tags, displayText: base };
  }

  /** íƒœê·¸ë§Œ ì œê±°í•œ í…ìŠ¤íŠ¸ ë°˜í™˜ â€” ìˆ˜ëŸ‰(xìˆ«ì)ì€ ìœ ì§€ (í í‘œì‹œìš©) */
  function stripTags(text) {
    const { base, qty } = parseItemText(text);
    return qty > 1 ? `${base} x${qty}` : base;
  }

  /** íƒœê·¸ ON/OFF í† ê¸€ (ì†ŒìŠ¤ë”°ë¡œÂ·ìŠ¤íŒŒì´ì‹œ ê³µí†µ) */
  function toggleTag(itemId, tag) {
    const item = findItemById(currentTable, itemId);
    if (!item) return;
    const { base, qty, tags } = parseItemText(item.text);
    const has = tags.includes(tag);
    const newTags = has ? tags.filter(t => t !== tag) : [...tags, tag];
    const withQty = qty > 1 ? `${base} x${qty}` : base;
    item.text = newTags.length ? `${withQty} ${newTags.join(' ')}` : withQty;
    save();
    renderOrders();
  }

  // Firebase ì‹¤ì‹œê°„ ë™ê¸°í™”
  function load() {
    onValue(ordersRef, (snapshot) => {
      // FirebaseëŠ” ë°°ì—´ì„ ê°ì²´ë¡œ ì €ì¥í•˜ë¯€ë¡œ ì•ˆì „í•˜ê²Œ ë³€í™˜
      const raw = snapshot.val() || {};
      orders = {};
      for (const table in raw) {
        const tableData = raw[table];
        if (Array.isArray(tableData)) {
          orders[table] = tableData.filter(Boolean);
        } else if (tableData && typeof tableData === 'object') {
          orders[table] = Object.values(tableData).filter(Boolean);
        }
      }
      document.getElementById('syncDot').classList.remove('off');
      document.getElementById('syncText').textContent = 'ì‹¤ì‹œê°„ ì—°ê²°';
      refreshAll();
      if (currentTable) renderOrders();
    }, () => {
      document.getElementById('syncDot').classList.add('off');
      document.getElementById('syncText').textContent = 'ì—°ê²° ì˜¤ë¥˜';
    });
  }

  function save() {
    const toSave = {};
    for (const table in orders) {
      if (orders[table] && orders[table].length > 0) {
        toSave[table] = orders[table];
      }
    }
    set(ordersRef, Object.keys(toSave).length > 0 ? toSave : null)
      .catch(() => {
        document.getElementById('syncDot').classList.add('off');
        document.getElementById('syncText').textContent = 'ì €ì¥ ì‹¤íŒ¨!';
        alert('âš ï¸ ì €ì¥ ì‹¤íŒ¨! ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
      });
  }

  function getOrders(t) { return orders[t] || []; }

  const TABLE_IDS = ['1','2','3-1','3-2','4','5','6','7','8','9','10','11','12-1','12-2'];

  function refreshAll() {
    let active = 0;
    for (const t of TABLE_IDS) {
      const list = getOrders(t);
      const btn = document.getElementById('tbl-' + t);
      const badge = document.getElementById('badge-' + t);
      if (!btn) continue;
      if (list.length > 0) {
        btn.classList.add('has-order');
        badge.textContent = list.length;
        active++;
      } else {
        btn.classList.remove('has-order');
        badge.textContent = '';
      }
    }
    document.getElementById('activeCount').textContent = `ì£¼ë¬¸ ${active}í…Œì´ë¸”`;
    renderQueue();
  }

  function renderQueue() {
    const allItems = buildQueueItems();
    allItems.sort((a, b) => a.id.localeCompare(b.id));

    const rawQ = document.getElementById('queueSearch').value.trim();
    const q = normalize(rawQ);
    const filtered = q ? filterQueueItems(allItems, q) : allItems;

    const el = document.getElementById('queueList');
    document.getElementById('queueCountBadge').textContent = allItems.length;

    if (allItems.length === 0) { el.innerHTML = '<div class="queue-empty">ğŸ‰ ëª¨ë“  ë©”ë‰´ê°€ ë‚˜ê°”ì–´ìš”!</div>'; return; }
    if (filtered.length === 0) { el.innerHTML = '<div class="queue-empty">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ì–´ìš”</div>'; return; }

    const katsu = [], other = [];
    filtered.forEach((item, i) => {
      if (isKatsuItem(item.text)) katsu.push({ item, i });
      else other.push({ item, i });
    });

    // ê²€ìƒ‰ ì¤‘ì´ê±°ë‚˜ í•œ ìª½ì´ ë¹„ì–´ìˆìœ¼ë©´ ë‹¨ì¼ ì»¬ëŸ¼
    if (q || katsu.length === 0 || other.length === 0) {
      el.innerHTML = filtered.map((item, i) => renderQueueItem(item, i, q, rawQ)).join('');
      return;
    }

    el.innerHTML = `
      <div class="queue-columns">
        <div>
          <div class="queue-col-title">ğŸ± ê¹ŒìŠ¤</div>
          <div class="queue-col">${katsu.map(({ item, i }) => renderQueueItem(item, i, q, rawQ)).join('')}</div>
        </div>
        <div>
          <div class="queue-col-title">ğŸ½ ê¸°íƒ€</div>
          <div class="queue-col">${other.map(({ item, i }) => renderQueueItem(item, i, q, rawQ)).join('')}</div>
        </div>
      </div>`;
  }

  /** ì „ì²´ í…Œì´ë¸” ì£¼ë¬¸ì„ í ì•„ì´í…œ ë°°ì—´ë¡œ ë³€í™˜ */
  function buildQueueItems() {
    const allItems = [];
    for (const t of TABLE_IDS) {
      getOrders(t).forEach(item => {
        allItems.push({
          table: t,
          text: item.text,
          time: item.time,
          id: item.id || item.time,
          sides: getSidesForText(item.text),
          checkedSides: item.checkedSides || [],
        });
      });
    }
    return allItems;
  }

  /** ê²€ìƒ‰ì–´ë¡œ í ì•„ì´í…œ í•„í„°ë§ */
  function filterQueueItems(allItems, q) {
    return allItems.filter(item => {
      if (normalize(item.text).includes(q)) return true;
      const matchedMenu = MENU.find(m => normalize(item.text).includes(normalize(m.ko)));
      if (!matchedMenu) return false;
      return matchedMenu.keywords && matchedMenu.keywords.some(k => normalize(k).includes(q));
    });
  }

  /** í ì•„ì´í…œ í•˜ë‚˜ì˜ HTML ìƒì„± */
  function renderQueueItem(item, i, q, rawQ) {
    const isSauceAside = item.text.includes(SAUCE_ASIDE_TAG);
    const isSpicy      = item.text.includes(SPICY_TAG);
    const rawText      = stripTags(item.text);
    const displayText = q ? highlightNormalized(rawText, rawQ) : escapeHtml(rawText);
    const sauceTag = isSauceAside ? ` <span class="sauce-aside-tag">ğŸ¥£ ì†ŒìŠ¤ë”°ë¡œ</span>` : '';
    const spicyTag = isSpicy      ? ` <span class="spicy-tag">ğŸŒ¶ï¸ ìŠ¤íŒŒì´ì‹œ</span>`      : '';

    const sidesHtml = item.sides.length > 0
      ? `<div class="side-checks">${item.sides.map(s => {
          const checked = item.checkedSides.includes(s) ? 'checked' : '';
          return `<button class="side-chip ${checked}" onclick="toggleSide('${item.table}','${item.id}','${s}',${i})">${s}</button>`;
        }).join('')}</div>`
      : '';

    return `<div class="queue-item ${q ? 'highlight' : ''}" id="qi-${i}">
      <div class="queue-table-tag">${item.table}</div>
      <div style="flex:1;min-width:0;">
        <div class="queue-item-text">${displayText}${sauceTag}${spicyTag}</div>
        <div class="queue-item-time">${item.time} ì£¼ë¬¸</div>
        ${sidesHtml}
      </div>
      <button class="queue-done-btn" onclick="serveItem('${item.table}','${item.id}',${i})">âœ“</button>
    </div>`;
  }

  // ê³µë°±ì„ ë¬´ì‹œí•˜ê³  í•˜ì´ë¼ì´íŠ¸ â€” ì´ëª¨ì§€(surrogate pair) ì•ˆì „ ì²˜ë¦¬
  function highlightNormalized(str, query) {
    const nStr = normalize(str);
    const nQ = normalize(query);
    const idx = nStr.indexOf(nQ);
    if (idx === -1) return escapeHtml(str);

    // ì´ëª¨ì§€ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ [...str] ë¡œ ì½”ë“œí¬ì¸íŠ¸ ë‹¨ìœ„ ìˆœíšŒ
    const chars = [...str];
    let ni = 0, start = -1, end = -1;
    for (let oi = 0; oi < chars.length; oi++) {
      const nc = normalize(chars[oi]);
      if (nc !== '') {
        if (ni === idx) start = oi;
        if (ni === idx + nQ.length - 1) { end = oi + 1; break; }
        ni++;
      }
    }
    if (start === -1) return escapeHtml(str);

    // chars ë°°ì—´ ê¸°ì¤€ìœ¼ë¡œ ìŠ¬ë¼ì´ìŠ¤ í›„ ì¬ì¡°í•©
    const before = chars.slice(0, start).join('');
    const match  = chars.slice(start, end).join('');
    const after  = chars.slice(end).join('');
    return escapeHtml(before) + '<em>' + escapeHtml(match) + '</em>' + escapeHtml(after);
  }

  function openTable(t) {
    currentTable = t;
    document.getElementById('modalTitle').textContent = `í…Œì´ë¸” ${t}`;
    renderOrders();
    document.getElementById('modalOverlay').classList.add('open');
    // ìë™ focus ì œê±° â€” ëª¨ë‹¬ ì˜¤í”ˆ ì‹œ í‚¤ë³´ë“œ ìë™ íŒì—… ë°©ì§€
  }

  function closeModal() {
    document.getElementById('modalOverlay').classList.remove('open');
    currentTable = null;
  }

  function handleOverlayClick(e) {
    if (e.target === document.getElementById('modalOverlay')) closeModal();
  }

  function renderOrders() {
    const list = getOrders(currentTable);
    const el = document.getElementById('ordersList');
    const body = document.querySelector('.modal-body');
    const scrollTop = body ? body.scrollTop : 0;

    document.getElementById('orderCount').textContent = list.length + 'ê°œ';
    document.getElementById('modalSubtitle').textContent = list.length > 0 ? `${list.length}ê°œ ì£¼ë¬¸ ì¤‘` : 'ì£¼ë¬¸ ì—†ìŒ';
    if (list.length === 0) { el.innerHTML = `<div class="empty-state"><span class="icon">ğŸ“</span>ì•„ì§ ì£¼ë¬¸ì´ ì—†ì–´ìš”</div>`; return; }
    el.innerHTML = list.map((item) => {
      const itemId       = item.id || item.time;
      const isClassic    = item.text.includes(CLASSIC_CUTLET_KO);
      const isClamSoup   = item.text.includes(CLAM_SOUP_KO);
      const { displayText: baseText, qty, tags } = parseItemText(item.text);
      const isSauceAside = tags.includes(SAUCE_ASIDE_TAG);
      const isSpicy      = tags.includes(SPICY_TAG);

      const sauceBtn = isClassic
        ? `<button class="sauce-toggle-btn ${isSauceAside ? 'active' : ''}" onclick="toggleSauceAside('${itemId}')">ğŸ¥£ ì†ŒìŠ¤ë”°ë¡œ</button>`
        : '';
      const spicyBtn = isClamSoup
        ? `<button class="spicy-toggle-btn ${isSpicy ? 'active' : ''}" onclick="toggleSpicy('${itemId}')">ğŸŒ¶ï¸ ìŠ¤íŒŒì´ì‹œ</button>`
        : '';

      return `<div class="order-item">
        <div class="order-item-time">${item.time}</div>
        <div class="order-item-text">${escapeHtml(baseText)}</div>
        ${sauceBtn}${spicyBtn}
        <div class="qty-ctrl">
          <button class="qty-ctrl-btn" onclick="changeQty('${itemId}',-1)">âˆ’</button>
          <span class="qty-ctrl-num">${qty}</span>
          <button class="qty-ctrl-btn" onclick="changeQty('${itemId}',1)">+</button>
        </div>
        <button class="order-item-del" onclick="deleteOrder('${itemId}')">âœ•</button>
      </div>`;
    }).join('');

    if (body) body.scrollTop = scrollTop;
  }

  function addOrder() {
    const input = document.getElementById('orderInput');
    const text = input.value.trim();
    if (!text || !currentTable) return null;
    if (!orders[currentTable]) orders[currentTable] = [];
    const now = new Date();
    const time = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
    const id = now.getTime().toString(36) + Math.random().toString(36).slice(2, 6); // ì¶©ëŒ ë°©ì§€
    orders[currentTable].push({ text, time, id });
    input.value = '';
    input.style.height = 'auto';
    save();
    renderOrders();
    setTimeout(() => { const b = document.querySelector('.modal-body'); if(b) b.scrollTop = b.scrollHeight; }, 50);
    return id;
  }

  function deleteOrder(itemId) {
    if (!currentTable || !orders[currentTable]) return;
    if (!confirm('ì´ ì£¼ë¬¸ì„ ì‚­ì œí• ê¹Œìš”?')) return;
    const idx = findItemIndexById(currentTable, itemId);
    if (idx !== -1) {
      orders[currentTable].splice(idx, 1);
      cleanTableOrders(currentTable);
      save();
      renderOrders();
    }
  }

  function clearAllOrders() {
    if (!currentTable) return;
    if (!confirm(`í…Œì´ë¸” ${currentTable}ì˜ ëª¨ë“  ì£¼ë¬¸ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
    delete orders[currentTable];
    save();
    refreshAll(); // í…Œì´ë¸” ë±ƒì§€ ì¦‰ì‹œ ê°±ì‹ 
    renderOrders();
  }

  const servingInProgress = new Set();

  function serveItem(table, itemId, queueIdx) {
    const key = `${table}-${itemId}`;
    if (servingInProgress.has(key)) return;
    servingInProgress.add(key);

    // ë°ì´í„°ëŠ” ì¦‰ì‹œ ì‚­ì œ â†’ Firebase ë ˆì´ìŠ¤ ë°©ì§€
    const idx = findItemIndexById(table, itemId);
    if (idx === -1) { servingInProgress.delete(key); return; }
    orders[table].splice(idx, 1);
    cleanTableOrders(table);
    save();
    refreshAll(); // í…Œì´ë¸” ë±ƒì§€ ì¦‰ì‹œ ê°±ì‹ 

    // ì• ë‹ˆë©”ì´ì…˜ì€ ì‹œê° íš¨ê³¼ë§Œ (ë°ì´í„°ëŠ” ì´ë¯¸ ì‚­ì œë¨)
    const el = document.getElementById('qi-' + queueIdx);
    if (el) {
      el.classList.add('served');
      setTimeout(() => { servingInProgress.delete(key); }, SERVE_ANIM_MS);
    } else {
      servingInProgress.delete(key);
    }
  }

  function toggleSide(table, itemId, side, queueIdx) {
    const item = findItemById(table, itemId);
    if (!item) return;
    if (!item.checkedSides) item.checkedSides = [];
    const pos = item.checkedSides.indexOf(side);
    if (pos === -1) item.checkedSides.push(side);
    else item.checkedSides.splice(pos, 1);
    save();
    const sides = getSidesForText(item.text);
    const sidesEl = document.querySelector(`#qi-${queueIdx} .side-checks`);
    if (sidesEl) {
      sidesEl.innerHTML = sides.map(s => {
        const checked = item.checkedSides.includes(s) ? 'checked' : '';
        return `<button class="side-chip ${checked}" onclick="toggleSide('${table}','${itemId}','${s}',${queueIdx})">${s}</button>`;
      }).join('');
    }
  }

  function clearServedAll() {
    if (!confirm('ëª¨ë“  ì£¼ë¬¸ì„ ì™„ë£Œ ì²˜ë¦¬í• ê¹Œìš”?')) return;
    orders = {};
    const searchEl = document.getElementById('queueSearch');
    if (searchEl) searchEl.value = '';
    save();
    refreshAll();                        // í…Œì´ë¸” ë±ƒì§€ ì¦‰ì‹œ ì´ˆê¸°í™”
    if (currentTable) renderOrders();
  }

  function selectMenu(i, e) {
    e.preventDefault();
    if (e.type === 'click' && e.sourceCapabilities === null) return; // iOS synthetic click ì°¨ë‹¨
    const box = document.getElementById('acBox');
    if (!box._results || !box._results[i]) return; // null ë°©ì–´
    const m = box._results[i];
    box.classList.remove('show');
    box.innerHTML = '';
    const input = document.getElementById('orderInput');
    input.value = `${m.ko} ${m.price}`;
    autoResize(input);
    addOrder();
  }

  function changeQty(itemId, delta) {
    const item = findItemById(currentTable, itemId);
    if (!item) return;
    const { base, qty, tags } = parseItemText(item.text);
    const next = Math.max(1, qty + delta);
    const withQty = next > 1 ? `${base} x${next}` : base;
    item.text = tags.length ? `${withQty} ${tags.join(' ')}` : withQty;
    save();
    renderOrders();
  }

  function toggleSauceAside(itemId) { toggleTag(itemId, SAUCE_ASIDE_TAG); }
  function toggleSpicy(itemId)      { toggleTag(itemId, SPICY_TAG); }

  function showAC(val) {
    const box = document.getElementById('acBox');
    const q = val.trim();
    if (!q) { box.classList.remove('show'); box.innerHTML = ''; return; }
    const qn = normalize(q);
    const results = MENU.filter(m =>
      normalize(m.ko).includes(qn) ||
      normalize(m.en).includes(qn) ||
      (m.keywords && m.keywords.some(k => normalize(k).includes(qn) || qn.includes(normalize(k))))
    ).slice(0, 8);
    if (!results.length) { box.classList.remove('show'); box.innerHTML = ''; return; }
    box.innerHTML = results.map((m, i) => `
      <div class="ac-item" ontouchend="selectMenu(${i},event)" onclick="selectMenu(${i},event)">
        <div class="ac-left">
          <div class="ac-name">${highlight(m.ko, q)}</div>
          <div class="ac-en">${highlight(m.en, q)}</div>
        </div>
        <div class="ac-price">${m.price}</div>
      </div>`).join('');
    box._results = results;
    box.classList.add('show');
  }

  function hideAC() { setTimeout(() => { document.getElementById('acBox').classList.remove('show'); }, 200); }
  function handleKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); addOrder(); } }
  function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 80) + 'px'; }

  // onclickì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì „ì—­ ë“±ë¡
  // ===== ë¹„ë°€ë²ˆí˜¸ =====
  const PIN_CORRECT = '0';
  const SESSION_KEY = 'rj_auth';
  let pinValue = '';

  function pinUpdateDots() {
    const dots = document.getElementById('pinDots');
    // ì…ë ¥ ê¸¸ì´ì— ë§ê²Œ dot ìƒì„± (ìµœì†Œ 1ê°œ)
    const len = Math.max(pinValue.length, 1);
    dots.innerHTML = Array.from({ length: len }, (_, i) =>
      `<div class="pin-dot ${i < pinValue.length ? 'filled' : ''}"></div>`
    ).join('');
  }

  function pinInput(digit) {
    if (pinValue.length >= 8) return;
    pinValue += digit;
    document.getElementById('pinError').textContent = '';
    pinUpdateDots();
  }

  function pinDelete() {
    pinValue = pinValue.slice(0, -1);
    document.getElementById('pinError').textContent = '';
    pinUpdateDots();
  }

  function pinConfirm() {
    if (pinValue === PIN_CORRECT) {
      sessionStorage.setItem(SESSION_KEY, '1');
      document.getElementById('pinOverlay').classList.add('hidden');
    } else {
      const errEl = document.getElementById('pinError');
      errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ì–´ìš”';
      pinValue = '';
      pinUpdateDots();
      // í”ë“¤ê¸° ì• ë‹ˆë©”ì´ì…˜
      const dots = document.getElementById('pinDots');
      dots.style.animation = 'none';
      dots.offsetHeight; // reflow
      dots.style.animation = 'shake 0.35s ease';
    }
  }

  // ì´ë¯¸ ì¸ì¦ëœ ì„¸ì…˜ì´ë©´ ë°”ë¡œ í†µê³¼
  if (sessionStorage.getItem(SESSION_KEY) === '1') {
    document.getElementById('pinOverlay').classList.add('hidden');
  }

  window.pinInput   = pinInput;
  window.pinDelete  = pinDelete;
  window.pinConfirm = pinConfirm;

  window.openTable = openTable;
  window.closeModal = closeModal;
  window.handleOverlayClick = handleOverlayClick;
  window.addOrder = addOrder;
  window.deleteOrder = deleteOrder;
  window.clearAllOrders = clearAllOrders;
  window.serveItem = serveItem;
  window.toggleSide = toggleSide;
  window.toggleSauceAside = toggleSauceAside;
  window.toggleSpicy      = toggleSpicy;
  window.clearServedAll = clearServedAll;
  window.renderQueue = renderQueue;
  window.handleKey = handleKey;
  window.autoResize = autoResize;
  window.showAC = showAC;
  window.hideAC = hideAC;
  window.selectMenu  = selectMenu;
  window.changeQty   = changeQty;

  load();
</script>
</body>
</html>
